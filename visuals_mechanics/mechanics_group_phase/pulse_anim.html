<html>

<head>
    <title>Pulse Anim</title>


</head>
<body>

<div id='graph'></div>  <!-- Plotly chart will be drawn inside this DIV -->

<div id="content"></div>
    	<!-- Put content here to make them central aligned -->
        <!--<h1>Home Page</h1> -->
        alpha: <input id="alpha" type ="range" value="10" min ="0" max="30" step ="1"/>
        <input id="run_button" type ="button" value="start" onclick="onStart()"/>
        <input id="reset_button" type ="button" value="reset" onclick="onReset()"/>
        <input id="pause_button" type ="button" value="pause" onclick="onPause()"/>

    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!--<script src="jquery-2.1.1.js"></script>-->
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>
    <script>

    // Defining variables (need to update later anyway so importing from e.g. json is meaningless)
    var n = 801;
    var x = [], y_i = [], y_r = [], y_t = [];
    var t = 0.0;
    var dt = 0.02;
    var v1 = 5.0;
    var alpha = valueSlider(parseInt($("#alpha").val()));
    var v2 = alpha*v1;
    var A = (v2-v1)/(v1+v2);
    var B = 2*v1/(v1+v2);
    var is_paused = false;

    // Log slider
    function valueSlider(position) {
        if (position <= 10) {
            return position*0.1;
        } else if (position < 20) {
            return position - 9;
        } else {
            return (position-20)*10+20;
        }
    }

    // Slider
    $('#alpha').on('change', function () {
        alpha = valueSlider(parseInt($("#alpha").val()));
        v2 = alpha*v1;
        A = (v2-v1)/(v1+v2);
        B = 2*v1/(v1+v2);
        onReset();
    });


    function onPause() {
        is_paused = true;
    }

    for (var i = 0; i < n; i++) {
        x[i] = -10 + i / 40;
        y_i[i] = (x[i] + 4) * Math.exp(-1*((x[i] + 4) * (x[i] + 4)) + (x[i] + 4));
        y_r[i] = 0;
        y_t[i] = 0;
    }

    function onReset() {
        onPause();
        t = 0;
        for (var i = 0; i < n; i++) {
            x[i] = -10 + i / 40;
            y_i[i] = (x[i] + 4) * Math.exp(-1*((x[i] + 4) * (x[i] + 4)) + (x[i] + 4));
            y_r[i] = 0;
            y_t[i] = 0;
        }
        Plotly.animate('graph', {
                   data: [{y: y_i}, {y: y_r}, {y: y_t}]
               },
               {transition: {duration: 0}, frame: {duration: 0, redraw: false}}
           );

    }

    // Data
    // Initial plot
    var incident = {
        x: x,
        y: y_i,
        name: "incident",
        line: {width: 1, color: '#ff00ff', simplify: false}
    };

    var reflected = {
        x: x,
        y: y_r,
        name: "reflected",
        line: {width: 1, color: 'blue', simplify: false}
    };

    var transmitted = {
        x: x,
        y: y_t,
        name: "transmitted",
        line: {width: 1, color: 'red', simplify: false}
    };

    var boundary = {
        x: [0,0],
        y: [-2,2],
        mode: "lines",
        name: "boundary",
        line: {width: 3, color: 'black', simplify: true}
    };

    // Plot graph with interactivity
    Plotly.plot('graph', [incident, reflected, transmitted, boundary], {
                xaxis: {range: [-10, 10]}},
        {
                yaxis: {range: [-1.3, 1.3]}}
    );


   // Data update function for animation
   var t_start = t;

   function compute() {
       t += dt;
       // need to find a way to define time limit
       if (t < t_start + 16) {
           for (var i = 0; i < n; i++) {
               if (x[i] < 0) {
                   y_i[i] = (x[i] + 4 - v1 * t) * Math.exp(-1*((x[i] + 4 - v1 * t) * (x[i] + 4 - v1 * t)) + (x[i] + 4 - v1 * t));
                   y_r[i] = A * (-x[i] + 4 - v1 * t) * Math.exp(-1*((-1*x[i] + 4 - v1 * t) * (-1*x[i] + 4 - v1 * t)) + (-1*x[i] + 4 - v1 * t));
               }
               else if (x[i] > 0) {
                   y_t[i] = B * (v1 / v2 * x[i] + 4 - v1 * t) * Math.exp(-1*((v1 / v2 * x[i] + 4 - v1 * t) * (v1 / v2 * x[i] + 4 - v1 * t)) + (v1 / v2 * x[i] + 4 - v1 * t));
               }
           }
       }

   }


   // Looping function that updates plot
   function update() {


       if (is_paused === false) {

           compute();

           Plotly.animate('graph', {
                   data: [{y: y_i}, {y: y_r}, {y: y_t}]
               },
               {transition: {duration: 0}, frame: {duration: 0, redraw: false} }, {
                xaxis: {range: [-10, 10]}},
                {
                yaxis: {range: [-1.3, 1.3]}}
               // vastly speeds up animation but won't update any non-animated properties
           );
           if (v1 > v2) {
               if (t > (7 / v1 + 10 / v2) && y_t[n-1] < 0.001 && y_t[n-1] > -0.001) {
                   onReset();
               }
               else requestAnimationFrame(update);
           }
           else if (v2 >= v1) {
               if (t > (17 / v1)) {
                   onReset();
               }
               else requestAnimationFrame(update);
           }
       }
       else is_paused = false;

   }

   function onStart() {
       is_paused = false;
       requestAnimationFrame(update);
}

</script>

</body>
</html>
