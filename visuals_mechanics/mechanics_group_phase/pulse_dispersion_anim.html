<!doctype html>
<html>
<head>
    <title>Pulse Animation</title>
    <link rel="stylesheet" href="./styles/styles.css">
    <link rel="icon" href="./images/favicon.ico" type="image/x-icon">
    <style>

        #graph {
            border: 3px solid #003E74;
        }
    </style>
</head>
<body>

<h1>Travelling pulse at interface (dispersive)</h1>
<div class="container">
    <div class="row">
        <div class="nine columns">
            <div id='graph'></div>  <!-- Plotly chart will be drawn inside this DIV -->
        </div>
        <div class="three columns">
            <!--<h1>Pulse </h1>-->
            <label class="sliderTitle">Velocity 1:<span id="v1Display" data-unit="m/s"> 1 m/s</span></label>
            <label class="slider">
                <input id="v1" class="inputs" type="range" value="2" min="0" max="20" step="1"/>
                <span class="sliderMin">0</span><span class="sliderMax">20</span>
            </label>
            <label class="sliderTitle">Alpha:<span id="alphaDisplay" data-unit="none"> 1</span></label>
            <label class="slider">
                <input id="alpha" class="inputs" type="range" value="10" min="0" max="28" step="1"/>
                <span class="sliderMin">0</span><span class="sliderMax">100</span>
            </label>
            <label> Velocity 2:<span id="v2Display" data-unit="m/s"> 1 m/s</span></label><br>
            <input id="run_button" type="button" value="play" onclick="onStart()" style="width:200px"/>
            <input id="reset_button" type="button" value="reset" onclick="onReset()" style="width:200px"/>

        </div>
    </div>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://code.jquery.com/jquery-latest.min.js"></script>

<script>

    // Defining variables (need to update later anyway so importing from e.g. json is meaningless)
    var k_len = 1;
    var dt = 0.02;
    var omega = 1.1;

    var n = 801;
    var x = [], y_i = [], y_r = [], y_t = [];
    var k = [];
    var t = 0.0;
    var v1 = 5;
    var alpha = valueSlider(parseInt($("#alpha").val()));
    var v2 = alpha * v1;
    var A = (v2 - v1) / (v1 + v2);
    var B = 2 * v1 / (v1 + v2);
    var is_paused = true;
    //var style = { font: "36px Lato", fill: "#003E74", wordWrap: false, align: "left", backgroundColor: "#f0f0f0" };
    var layout =
    {
        autosize: false,
        width: 700,
        height: 600,
        margin: {
            l: 50,
            r: 50,
            b: 100,
            t: 100,
            pad: 4
        },
        //plot_bgcolor: '#EBEEEE',
//        xaxis: {
//            range: [-10, 10]
//        },
//        yaxis: {
//            range: [-1.6, 1.6]
//        },
        font: {
            family: 'Lato',
            size: 18,
            color: '#003E74',
            weight: 900
        }
    };


    // Slider values (for alpha)
    function valueSlider(position) {
        if (position <= 10) {
            return (position * 0.1).toFixed(1);
        } else if (position < 20) {
            return position - 9;
        } else {
            return (position - 20) * 10 + 20;
        }
    }

    // Slider alpha
    $('#alpha').on('input', function () {
        alpha = valueSlider(parseInt($("#alpha").val()));
        $("#alphaDisplay").text(" " + alpha);
        v2 = alpha * v1;
        $("#v2Display").text(" " + v2 + " m/s");
        A = (v2 - v1) / (v1 + v2);
        B = 2 * v1 / (v1 + v2);
        onReset();
    })

    // Slider v1
    $('#v1').on('input', function () {
        v1 = parseInt($("#v1").val());
        $("#v1Display").text(" " + v1 + " m/s");
        v2 = alpha * v1;
        A = (v2 - v1) / (v1 + v2);
        B = 2 * v1 / (v1 + v2);
        onReset();
    });

    function compute_k_values(){
        for (var i = 0; i < k_len; i++) {
            k[i] = i + 1;
        }
    }

    function initial_data(){
        for (var i = 0; i < n; i++) {
            x[i] = -20 + i / 10;
            y_i[i] = 0;
            for (var j = 0; j < k_len; j++) {
                y_i[i] +=  Math.sin(x[i] - t) + Math.sin(k[j] * x[i] - k[j]* t);
            }
            y_r[i] = 0;
            y_t[i] = 0;
        }
    }

    function onReset() {
        is_paused = true;
        t = 0;
        for (var i = 0; i < n; i++) {
            x[i] = -10 + i / 10;
            y_i[i] = 0;
            for (var j = 0; j < k_len; j++) {
                y_i[i] +=  Math.sin(x[i] - t) + Math.sin(k[j] * x[i] - k[j]* t);
            }
            y_r[i] = 0;
            y_t[i] = 0;
        }
        Plotly.animate('graph', {
                    data: [{y: y_i}, {y: y_r}, {y: y_t}]
                },
                {
                    transition: {duration: 0}, frame: {duration: 0, redraw: false}
                }
        );
        document.getElementById('run_button').value = (is_paused) ? "Play" : "Pause";

    }

    // Data
    compute_k_values();
    initial_data();

    // Initial plot
    var incident = {
        x: x,
        y: y_i,
        name: "incident",
        line: {width: 2, color: '#960078', simplify: false}
    };

    var reflected = {
        x: x,
        y: y_r,
        name: "reflected",
        line: {width: 2, color: '#E40043', simplify: false}
    };

    var transmitted = {
        x: x,
        y: y_t,
        name: "transmitted",
        line: {width: 2, color: '#00ACD7', simplify: false}
    };

    var boundary = {
        x: [0, 0],
        y: [-4, 4],
        mode: "lines",
        name: "boundary",
        line: {width: 3, color: 'black', simplify: false}
    };

    var xline = {
        x: [-15, 15],
        y: [0, 0],
        mode: "lines",
        showlegend: false,
        line: {width: 2, color: '#003E74', simplify: false}
    };

    // Plot graph with interactivity
    Plotly.plot('graph', [incident, reflected, transmitted, boundary, xline],
            layout
    );


    // Data update function for animation
    var t_start = t;

    function compute() {
        t += dt;
        // need to find a way to define time limit
        if (t < t_start + 16) {
            for (var i = 0; i < n; i++) {
                if (x[i] < 0) {
                    y_i[i] = 0;
                    y_r[i] = 0;
                    for (var j = 0; j < k_len; j++) {
                        y_i[i] +=  Math.sin(x[i] - t) + Math.sin(k[j] * x[i] - k[j]* t);
//                        y_r[i] +=  Math.sin(x[i] - t) + Math.sin(1.2 * k[j] * x[i] - omega * k[j]* t);
                    }
                }
                else if (x[i] > 0) {
                    y_i[i] = 0;
                    y_t[i] = 0;
                    for (var j_ = 0; j_ < k_len; j_++) {
                        y_t[i] +=  Math.sin(x[i] - t) + Math.sin(1.2 * k[j_] * x[i] - omega * k[j_]* t);
                    }
                }
            }
        }

    }

    // Looping function that updates plot
    function update() {

        if (is_paused === false) {

            compute();

            Plotly.animate('graph',
                    {data: [{y: y_i}, {y: y_r}, {y: y_t}]},
                    {transition: {duration: 0}, frame: {duration: 0, redraw: false}}
                    // vastly speeds up animation but won't update any non-animated properties
            );
            if (v1 > v2) {
                if (t > (7 / v1 + 10 / v2) && y_t[n - 1] < 0.001 && y_t[n - 1] > -0.001) {
                    onReset();
                }
                else requestAnimationFrame(update);
            }
            else if (v2 >= v1) {
                if (t > (17 / v1)) {
                    onReset();
                }
                else requestAnimationFrame(update);
            }
        }
    }

    function onStart() {
        is_paused = !is_paused;
        document.getElementById('run_button').value = (is_paused) ? "Play" : "Pause";
        requestAnimationFrame(update);
    }

    // ToDo: Linspace
    // ToDo: Wave on left
    // ToDo: Endpoint
    // ToDo: Change Initial Wave
    // ToDo: Dispersion
    // ToDo: Python?

</script>

</body>
</html>
